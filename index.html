<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DuCheffton Lite (View)</title>
</head>
<body>

<h1 class="header">DuCheffton Lite</h1>

<div id="app">
  <div class="filterArea">
    <input type="search" id="filtroTexto" placeholder="Buscar por nome ou número..." class="form-input">
    <input type="date" id="filtroData" class="form-input">
    <button id="btnFiltrar" class="btn btn-primary">Buscar</button>
  </div>
  
  <div id="lista">Carregando pedidos...</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<style>
body{
  font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif;
  margin:0;
  background:#f4f4f4; /* Fundo cinza claro */
  color:#333;
  font-size: 16px; /* Tamanho base maior */
}
#app{
  padding: 16px;
  box-sizing: border-box;
}
.header{
  font-size:24px;
  font-weight:700;
  margin:0;
  padding: 16px;
  text-align:center;
  background: #2c3e50; /* Header escuro */
  color: #fff;
}
.filterArea{
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
  flex-wrap: wrap; /* Responsivo */
}
.form-input {
  border: 1px solid #ccc;
  width: 100%;
  padding: 12px; /* Inputs maiores */
  font-size: 16px;
  border-radius: 8px;
  background: #fff;
  box-sizing: border-box;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.form-input:focus {
  border-color: #e67e22; /* Foco Laranja */
  box-shadow: 0 0 5px rgba(230, 126, 34, 0.4);
  outline: none;
}
#filtroTexto {
  flex: 2 1 250px; /* Campo de busca maior */
}
#filtroData {
  flex: 1 1 150px;
}
.box{
  background:#ffffff;
  border-radius:10px;
  border:1px solid #ddd;
  padding: 16px;
  margin: 16px 0;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  transition: all 0.3s ease-out; /* Animação simples */
}
/* Animação compatível com iPad 2 */
.box:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 12px rgba(0,0,0,0.1);
}
.box-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  border-bottom: 1px dashed #eee;
  padding-bottom: 8px;
}
.box-header b{
  font-size: 22px; /* Nome bem grande */
  color: #e67e22; /* Laranja */
  font-weight: 700;
}
.pago-span {
  font-size: 14px;
  font-weight: bold;
  color: #27ae60; /* Verde */
  background: #eafaf1;
  padding: 4px 8px;
  border-radius: 4px;
  white-space: nowrap;
}
.box-cliente-info {
  font-size: 16px;
  color: #555;
  line-height: 1.5;
  margin-bottom: 10px;
}
.box-cliente-info i {
  display: block; /* Para 'Entrega' ficar em linha separada */
  font-style: normal;
}
.box .itens-display{
  background:#fdfdfd; 
  padding: 10px; 
  margin: 10px 0; 
  border-radius: 6px; 
  border: 1px solid #f0f0f0;
  font-size: 16px;
  line-height: 1.5;
  white-space: pre-wrap; 
}
.box-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 12px;
  border-top: 1px solid #f0f0f0;
  padding-top: 12px;
}
.data-pedido {
  font-size: 14px;
  color: #777;
}
.valor-pedido {
  font-size: 20px;
  font-weight: bold;
  color: #333;
}
button{
  cursor:pointer;
  border-radius: 8px;
  font-weight:700;
  padding: 12px 16px; /* Botões maiores */
  font-size: 16px;
  border: none;
  transition: opacity 0.2s;
}
button:hover {
  opacity: 0.85;
}
.btn.btn-primary {
  background: #e67e22; /* Laranja */
  color: white;
  flex: 1 1 100px;
}
#lista{
  margin-top:12px;
  padding-top: 10px;
}
</style>

<script>
// Firebase v8 (namespaced) config
var firebaseConfig = {
  apiKey: "AIzaSyChkboBPp21hQ_tRFQrV2Hi3iBF-WHxWSE",
  authDomain: "gerenciador-de-pedidos-4ac32.firebaseapp.com",
  projectId: "gerenciador-de-pedidos-4ac32",
  storageBucket: "gerenciador-de-pedidos-4ac32.firebasestorage.app",
  messagingSenderId: "674975621927",
  appId: "1:674975621927:web:a09ad1f5c57c2dcb00ff02"
};
firebase.initializeApp(firebaseConfig);
window.db = firebase.firestore();
</script>

<script>
// Cache global para os pedidos (evita buscas no Firebase ao digitar)
var allPedidos = []; 

function escapeHTML(str) {
  if (!str) return '';
  return str.replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
}

function toLocaleDateStringSafe(ts){
  try{
    if(!ts) return '-';
    if(typeof ts.toDate === 'function') return ts.toDate().toLocaleString('pt-BR');
    return new Date(ts).toLocaleString('pt-BR');
  }catch(e){ return '-'; }
}

$(function(){
  // 1. Carrega a lista inicial (todos ativos)
  carregarLista();

  // 2. Botão "Buscar" (data) - Recarrega do Firebase
  $(document).on('click','#btnFiltrar', function(){
    var val = $("#filtroData").val();
    if(val){
      var parts = val.split('-'); 
      var dt = new Date(parseInt(parts[0],10), parseInt(parts[1],10)-1, parseInt(parts[2],10));
      carregarLista(dt); // Busca por data
    } else {
      carregarLista(); // Busca todos ativos
    }
  });
  
  // 3. Pesquisa (texto) - Filtra a lista já carregada (rápido)
  $(document).on('keyup', '#filtroTexto', function(){
    renderizarLista(); // Apenas re-renderiza o cache
  });
});

// Passo 1: Busca dados do Firebase e salva no cache
function carregarLista(filtroData){
  $("#lista").html('Carregando pedidos...');
  var ref = db.collection('pedidos').where('status','==','active').orderBy('horario','asc');
  
  if(filtroData){
    var inicio = new Date(filtroData.getFullYear(), filtroData.getMonth(), filtroData.getDate());
    var fim = new Date(inicio); fim.setDate(fim.getDate()+1);
    ref = db.collection('pedidos').where('status','==','active').where('horario','>=', firebase.firestore.Timestamp.fromDate(inicio)).where('horario','<', firebase.firestore.Timestamp.fromDate(fim)).orderBy('horario','asc');
  }
  
  ref.get().then(function(snap){
    window.allPedidos = []; // Limpa o cache
    snap.forEach(function(doc){
      var d = doc.data();
      window.allPedidos.push(d); // Salva no cache
    });
    renderizarLista(); // Renderiza pela primeira vez
  }).catch(function(err){
    console.error(err);
    $("#lista").html('Erro ao carregar pedidos.');
  });
}

// Passo 2: Renderiza o cache (aplicando filtro de texto)
function renderizarLista(){
  var termoBusca = ($("#filtroTexto").val() || '').trim().toLowerCase();
  var pedidosFiltrados = window.allPedidos;

  // Filtra o cache 'allPedidos' se houver termo de busca
  if (termoBusca) {
    pedidosFiltrados = window.allPedidos.filter(function(d){
      var nome = (d.nome || '').toLowerCase();
      var numero = (d.numero || '').toLowerCase();
      return nome.indexOf(termoBusca) > -1 || numero.indexOf(termoBusca) > -1;
    });
  }
  
  // Geração do HTML (com novo layout de card)
  var html = '';
  pedidosFiltrados.forEach(function(d){
    var dataStr = toLocaleDateStringSafe(d.horario);
    var valorStr = (d.valor != null) ? Number(d.valor).toFixed(2) : '0.00';
    var pagoStr = d.pago ? '<span class="pago-span">Pago</span>' : '';
    
    var nomeStr = escapeHTML(d.nome || '-');
    var numeroStr = d.numero ? '<span>Tel: ' + escapeHTML(d.numero) + '</span>' : ''; 
    
    var tipoStr = escapeHTML(d.tipoEntrega || 'Entrega');
    var enderecoStr = (tipoStr === 'Entrega') ? (': ' + escapeHTML(d.endereco||'N/D')) : '';
    
    var itensStr = escapeHTML(d.itens || '-');

    html += '<div class="box">' +
              '<div class="box-header">' +
                '<b>'+ nomeStr +'</b>' + 
                pagoStr +
              '</div>' +
              '<div class="box-cliente-info">' +
                numeroStr +
                '<i>' + tipoStr + enderecoStr + '</i>' +
              '</div>' +
              '<div class="itens-display">' + itensStr + '</div>' +
              '<div class="box-footer">' +
                '<span class="data-pedido">' + dataStr + '</span>' +
                '<span class="valor-pedido">R$ ' + valorStr + '</span>' +
              '</div>' +
            '</div>';
  });
  
  $("#lista").html(html || '<div class="box">Nenhum pedido encontrado.</div>');
}

</script>
</body>
</html>