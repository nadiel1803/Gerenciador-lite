<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DuCheffton Lite</title>
</head>
<body>

<div id="app">
  <h1 class="header">Pedidos</h1>
  <div class="topActions">
    <button id="newPedido" class="btn">Novo Pedido</button>
  </div>
  <div id="lista"></div>
  
  <div id="formArea" style="display:none;">
    <h2 id="formTitle">Novo Pedido</h2>

    <div class="form-columns-wrapper">
      
      <div class="form-column" id="colCliente">
        <h3>Dados do Cliente</h3>
        
        <label for="nome">Nome</label>
        <input id="nome">
        
        <label for="numero">Número do cliente</label>
        <input id="numero" placeholder="Opcional">
        
        <label for="tipoEntrega">Entrega ou Retirada?</label>
        <select id="tipoEntrega">
          <option value="Entrega">Entrega</option>
          <option value="Retirada">Retirada</option>
        </select>
        
        <div id="enderecoArea">
          <label for="endereco">Endereço</label>
          <input id="endereco" placeholder="Endereço">
        </div>
      </div>

      <div class="form-column" id="colDetalhes">
        <h3>Detalhes do Pedido</h3>
        
        <label for="itens">Itens do pedido</label>
        <textarea id="itens" placeholder="Ex: 2x pizza, 1x refrigerante"></textarea>
        
        <div class="form-row"> <div class="form-field-half" id="horarioArea"> 
            <label>Horário</label>
            <input type="date" id="horarioData" style="margin-bottom: 4px;">
            <div id="horarioInputsWrapper">
              <input id="horaInput" type="tel" maxlength="2" placeholder="HH">
              <input id="minutoInput" type="tel" maxlength="2" placeholder="MM">
            </div>
          </div>

          <div class="form-field-half" id="valorWrapper">
            <label for="valor">Valor (R$)</label>
            <input id="valor" placeholder="0.00" type="number">
          </div>
        </div>

        <div class="form-row"> <div class="form-field-half" id="pagoCheckboxWrapper">
             <input type="checkbox" id="pago">
          </div>
          <div class="form-field-half" id="pagoLabelWrapper">
            <label for="pago">Pedido pago</label> 
          </div>
        </div>
      </div> 

    </div> 

    <div style="margin-top:12px;display:flex;gap:8px;">
      <button id="salvar" class="btn">Salvar</button>
      <button id="cancelar" class="btn">Cancelar</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<style>
body{font-family:Arial, Helvetica, sans-serif;margin:0;background:#f4f4f4;color:#222;}
#app{max-width:680px;margin:0 auto;padding:16px;}
.header{font-size:22px;font-weight:700;margin:12px 0;text-align:center}
.topActions{display:flex;gap:10px;margin:10px 0;align-items:center}
.box{background:#ffffff;border-radius:8px;border:1px solid #e1e1e1;padding:12px;margin:12px 0;box-shadow:none;}
.box b{font-size:16px}
.box .itens-display{
  background:#f9f9f9; 
  padding: 6px 8px; 
  margin: 6px 0; 
  border-radius: 4px; 
  border: 1px solid #eee;
  font-size: 14px;
  line-height: 1.4;
  white-space: pre-wrap; 
}
input, textarea, select{border:1px solid #ccc;width:100%;padding:8px;border-radius:6px;background:#fff;box-sizing:border-box}
label{
  font-size:12px;
  font-weight:bold;
  color:#444;
  display: block;
  margin-bottom: 4px;
}
h3{font-size:16px; margin: 12px 0 8px 0; border-bottom: 1px solid #ddd; padding-bottom: 4px;}
button{cursor:pointer;border-radius:6px}
.btn{background:#f0f0f0;border:1px solid #d0d0d0;padding:8px 12px;font-weight:700}
.btn:hover{background:#e8e8e8}
.btn.del{background:#ffecec;border:1px solid #f2c2c2}
.btn.filter{background:#e8fbff;border:1px solid #cfeef8}
#lista{margin-top:12px}
#formArea{background:#fff;padding:12px;border-radius:8px;border:1px solid #e8e8e8}
#formTitle{text-align:center;margin-bottom:10px}
.form-columns-wrapper {
  display: flex;
  gap: 16px;
}
.form-column {
  flex: 1;
  min-width: 0; 
}
.form-row {
  display: flex;
  gap: 8px;
  margin-top: 8px;
  align-items: flex-start; 
}
.form-field-half {
  flex: 1;
  min-width: 0; 
}
#itens { 
  height: 104px; 
}
#horarioInputsWrapper { 
  display: flex; 
  gap: 8px; 
}
#horaInput, #minutoInput { 
  text-align: center; 
}
#pagoCheckboxWrapper { 
  padding-top: 5px; 
}
#pagoLabelWrapper label { 
  padding-top: 5px; 
  font-weight: normal; 
  display: block; 
}
label[for="pago"] {
  display: inline-block; 
  margin-bottom: 0;
  font-weight: normal;
}
</style>

<script>
// Firebase v8 (namespaced) config
var firebaseConfig = {
  apiKey: "AIzaSyChkboBPp21hQ_tRFQrV2Hi3iBF-WHxWSE",
  authDomain: "gerenciador-de-pedidos-4ac32.firebaseapp.com",
  projectId: "gerenciador-de-pedidos-4ac32",
  storageBucket: "gerenciador-de-pedidos-4ac32.firebasestorage.app",
  messagingSenderId: "674975621927",
  appId: "1:674975621927:web:a09ad1f5c57c2dcb00ff02"
};
firebase.initializeApp(firebaseConfig);
window.db = firebase.firestore();
</script>

<script>
// App logic
var pedidoAtualOriginalHorario = null; 

function escapeHTML(str) {
  if (!str) return '';
  return str.replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
}

function toLocaleDateStringSafe(ts){
  try{
    if(!ts) return '-';
    if(typeof ts.toDate === 'function') return ts.toDate().toLocaleString('pt-BR');
    return new Date(ts).toLocaleString('pt-BR');
  }catch(e){ return '-'; }
}

function toYYYYMMDD(date) {
  var Y = date.getFullYear();
  var Mo = date.getMonth() + 1;
  var D = date.getDate();
  return Y + '-' + (Mo < 10 ? '0' + Mo : Mo) + '-' + (D < 10 ? '0' + D : D);
}

$(function(){
  $("#newPedido").before('<input type="date" id="filtroData" style="margin-right:8px;padding:8px;border-radius:6px;border:1px solid #ccc"> <button class="btn filter" id="btnFiltrar">Filtrar</button>');
  carregar();

  $("#tipoEntrega").change(function(){
    if($(this).val() === 'Entrega'){
      $("#enderecoArea").show();
    } else {
      $("#enderecoArea").hide();
      $("#endereco").val(''); 
    }
  });

  // MUDANÇA: newPedido agora preenche o horário atual
  $("#newPedido").click(function(){
    $("#formArea").show();
    $("#formTitle").text("Novo Pedido");
    window.pedidoAtual = null;
    pedidoAtualOriginalHorario = null;
    
    // Limpar campos
    $("#nome").val(''); $("#numero").val(''); $("#itens").val(''); $("#valor").val('');
    $("#tipoEntrega").val('Entrega');
    $("#endereco").val('');
    $("#pago").prop('checked', false);
    $("#enderecoArea").show();
    
    // MUDANÇA: Preencher horário com data/hora ATUAIS
    var dataAgora = new Date();
    $("#horarioData").val(toYYYYMMDD(dataAgora));
    var H = dataAgora.getHours();
    var M = dataAgora.getMinutes();
    $("#horaInput").val(H < 10 ? '0' + H : H);
    $("#minutoInput").val(M < 10 ? '0' + M : M);
  });

  $("#cancelar").click(function(){ $("#formArea").hide(); });

  $("#salvar").click(function(){
    var nome = ($("#nome").val()||'').trim();
    var itens = ($("#itens").val()||'').trim();
    var valor = parseFloat(($("#valor").val()||'0').replace(',','.')) || 0;
    if(!nome || !itens){ alert('Preencha nome e itens'); return; }
    
    var tipoEntrega = $("#tipoEntrega").val();
    var endereco = (tipoEntrega === 'Entrega') ? ($("#endereco").val()||'').trim() : null;
    var pago = $("#pago").is(':checked');

    var dados = {
      nome: nome,
      numero: ($("#numero").val()||'').trim() || null,
      itens: itens,
      valor: valor,
      status: 'active',
      tipoEntrega: tipoEntrega,
      endereco: endereco,
      pago: pago
    };

    // MUDANÇA: Função unificada para ler o horário (para Edição E Novo)
    function getHorarioFromInputs() {
      var dateStr = $("#horarioData").val(); 
      var H = parseInt($("#horaInput").val() || '0', 10);
      var M = parseInt($("#minutoInput").val() || '0', 10);
      
      if (!dateStr || dateStr.split('-').length !== 3) {
        alert('Por favor, selecione uma data válida.'); return null;
      }
      if (H < 0 || H > 23 || M < 0 || M > 59) {
        alert('Hora ou minuto inválido.'); return null;
      }
      var parts = dateStr.split('-');
      var Y = parseInt(parts[0], 10);
      var Mo = parseInt(parts[1], 10) - 1; 
      var D = parseInt(parts[2], 10);
      return new Date(Y, Mo, D, H, M, 0, 0);
    }
    
    var newDate = getHorarioFromInputs();
    if (newDate === null) return; // Validação falhou

    if(window.pedidoAtual){
      // EDITANDO
      var originalDate = new Date();
      if (pedidoAtualOriginalHorario) {
          originalDate = pedidoAtualOriginalHorario.toDate();
      }
      originalDate.setSeconds(0, 0); 

      // Só atualiza o horário se for diferente
      if (newDate.getTime() !== originalDate.getTime()) {
        dados.horario = firebase.firestore.Timestamp.fromDate(newDate);
      }
      
      db.collection('pedidos').doc(window.pedidoAtual).update(dados).then(function(){
        $("#formArea").hide(); carregar();
      }).catch(function(err){ alert('Erro: '+(err && err.message)); });
    
    } else {
      // NOVO PEDIDO
      // MUDANÇA: Usa o horário lido dos inputs
      dados.horario = firebase.firestore.Timestamp.fromDate(newDate);
      
      db.collection('pedidos').add(dados).then(function(){
        $("#formArea").hide(); carregar();
      }).catch(function(err){ alert('Erro: '+(err && err.message)); });
    }
  });

  $(document).on('click','#btnFiltrar', function(){
    var val = $("#filtroData").val();
    if(val){
      var parts = val.split('-'); 
      var dt = new Date(parseInt(parts[0],10), parseInt(parts[1],10)-1, parseInt(parts[2],10));
      carregar(dt);
    } else {
      carregar();
    }
  });

});

function carregar(filtroData){
  $("#lista").html('Carregando...');
  var ref = db.collection('pedidos').where('status','==','active').orderBy('horario','asc');
  if(filtroData){
    var inicio = new Date(filtroData.getFullYear(), filtroData.getMonth(), filtroData.getDate());
    var fim = new Date(inicio); fim.setDate(fim.getDate()+1);
    ref = db.collection('pedidos').where('status','==','active').where('horario','>=', firebase.firestore.Timestamp.fromDate(inicio)).where('horario','<', firebase.firestore.Timestamp.fromDate(fim)).orderBy('horario','asc');
  }
  ref.get().then(function(snap){
    var html = '';
    snap.forEach(function(doc){
      var d = doc.data();
      var dataStr = toLocaleDateStringSafe(d.horario);
      var valorStr = (d.valor != null) ? Number(d.valor).toFixed(2) : '0.00';
      var pagoStr = d.pago ? ' (Pago)' : '';
      var nomeStr = escapeHTML(d.nome || '-');
      var numeroStr = d.numero ? 'Tel: ' + escapeHTML(d.numero) + '<br/>' : ''; 
      var tipoStr = escapeHTML(d.tipoEntrega || 'Entrega');
      var enderecoStr = (tipoStr === 'Entrega') ? (': ' + escapeHTML(d.endereco||'N/D')) : '';
      var itensStr = escapeHTML(d.itens || '-');

      html += '<div class="box">' +
              '<b>'+ nomeStr +'</b>' + pagoStr + '<br/>' +
              numeroStr +
              '<i>' + tipoStr + enderecoStr + '</i>' +
              '<div class="itens-display">' + itensStr + '</div>' +
              dataStr + '<br/>R$ ' + valorStr + '<br/>' +
              '<button class="btn" onclick="abrir(\''+ doc.id +'\')">Editar</button> ' +
              '<button class="btn del" onclick="excluir(\''+ doc.id +'\')">Excluir</button>' +
              '</div>';
    });
    $("#lista").html(html || 'Nenhuma pedido.');
  }).catch(function(err){
    console.error(err);
    $("#lista").html('Erro ao carregar pedidos.');
  });
}

// MUDANÇA: 'abrir' agora não precisa mostrar #horarioArea
function abrir(id){
  window.pedidoAtual = id;
  db.collection('pedidos').doc(id).get().then(function(doc){
    var d = doc.data() || {};
    $("#formArea").show();
    $("#formTitle").text('Editar Pedido');
    $("#nome").val(d.nome||'');
    $("#numero").val(d.numero||'');
    $("#itens").val(d.itens||'');
    $("#valor").val(d.valor != null ? d.valor : '');
    
    $("#tipoEntrega").val(d.tipoEntrega || 'Entrega');
    $("#endereco").val(d.endereco || '');
    $("#pago").prop('checked', d.pago || false);
    
    if($("#tipoEntrega").val() === 'Entrega'){
      $("#enderecoArea").show();
    } else {
      $("#enderecoArea").hide();
    }

    var dataOriginal = new Date();
    if(d.horario && typeof d.horario.toDate === 'function') {
      pedidoAtualOriginalHorario = d.horario;
      dataOriginal = d.horario.toDate();
    } else {
      pedidoAtualOriginalHorario = firebase.firestore.Timestamp.fromDate(dataOriginal);
    }
    
    $("#horarioData").val(toYYYYMMDD(dataOriginal));
    
    var H = dataOriginal.getHours();
    var M = dataOriginal.getMinutes();
    $("#horaInput").val(H < 10 ? '0' + H : H);
    $("#minutoInput").val(M < 10 ? '0' + M : M);
    
    // Nao precisa mais de: $("#horarioArea").show();

  }).catch(function(err){ alert('Erro: '+(err && err.message)); });
}

function excluir(id){
  if(!confirm('Deseja excluir este pedido?')) return;
  db.collection('pedidos').doc(id).delete().then(function(){ carregar(); }).catch(function(err){ alert('Erro ao excluir: '+(err && err.message)); });
}

</script>
</body>
</html>